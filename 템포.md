# ⏱️ Grafana Tempo 설치 및 스프링 부트 연동 가이드

본 문서는 트레이싱(Tracing) 데이터 수집을 위한 **Grafana Tempo (v2.8.2)** 서버 구축과 **Spring Boot** 애플리케이션 연동(Loki-Tempo 연결 포함) 방법을 안내합니다.

---

## 1. Tempo 서버 설치 및 설정 (Rocky Linux 기준)

### 1.1 서버 환경 준비
보안과 데이터 관리를 위해 전용 계정과 디렉토리를 먼저 준비합니다.

```bash
# 1. 템포 전용 계정 생성
sudo useradd --no-create-home --shell /bin/false tempo

# 2. 설정 및 데이터 디렉토리 생성
sudo mkdir -p /etc/tempo
sudo mkdir -p /var/lib/tempo/traces
sudo mkdir -p /var/lib/tempo/wal

# 3. 권한 부여
sudo chown -R tempo:tempo /etc/tempo /var/lib/tempo
```

### 1.2 Tempo v2.8.2 바이너리 설치
공식 GitHub 릴리즈에서 바이너리를 다운로드하여 설치합니다.

```bash
cd /tmp
# v2.8.2 버전 다운로드
curl -LO https://github.com/grafana/tempo/releases/download/v2.8.2/tempo_2.8.2_linux_amd64.tar.gz
tar -xvf tempo_2.8.2_linux_amd64.tar.gz

# 바이너리 이동 및 실행 권한 부여
sudo mv tempo /usr/local/bin/tempo
sudo chmod +x /usr/local/bin/tempo
```

### 1.3 설정 파일 작성 (`/etc/tempo/tempo.yaml`)
수신기(Receiver)와 저장소(Storage), 그리고 데이터 보관 주기(Retention)를 설정합니다.

```yaml
server:
  http_listen_port: 3200

distributor:
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: "0.0.0.0:4317"
        http:
          endpoint: "0.0.0.0:4318"

storage:
  trace:
    backend: local # 로컬 디스크 사용
    local:
      path: /var/lib/tempo/traces
    wal:
      path: /var/lib/tempo/wal # 급작스러운 종료 시 데이터 유실 방지용

compactor:
  compaction:
    block_retention: 720h # 30일 보관 (Loki 설정과 일치 권장)
    compacted_block_retention: 1h
```

### 1.4 Systemd 서비스 등록
서버 재부팅 시 자동 실행되도록 서비스를 등록합니다.

```bash
sudo vi /etc/systemd/system/tempo.service
```

**[서비스 파일 내용]**
```ini
[Unit]
Description=Grafana Tempo
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/tempo -config.file=/etc/tempo/tempo.yaml
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

```bash
# 서비스 활성화 및 시작
sudo systemctl daemon-reload
sudo systemctl enable --now tempo
```

---

## 2. 스프링 부트 애플리케이션 연동

### 2.1 Maven 의존성 설정 (`pom.xml`)
Micrometer 및 OpenTelemetry를 사용하여 트레이싱 데이터를 생성하고 전송합니다.

```xml
<dependencies>
    <!-- Tracing & OpenTelemetry -->
    <dependency>
        <groupId>io.micrometer</groupId>
        <artifactId>micrometer-tracing-bridge-otel</artifactId>
    </dependency>
    <dependency>
        <groupId>io.opentelemetry</groupId>
        <artifactId>opentelemetry-exporter-otlp</artifactId>
    </dependency>
</dependencies>
```

### 2.2 전역 트레이싱 구현 (`GlobalTracingAspect.java`)
AOP를 활용하여 Controller, Service, Mapper의 실행 시간을 자동으로 기록합니다.

```java
import io.micrometer.observation.Observation;
import io.micrometer.observation.ObservationRegistry;
import lombok.RequiredArgsConstructor;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Pointcut;
import org.springframework.stereotype.Component;

@Aspect
@Component
@RequiredArgsConstructor
public class GlobalTracingAspect {

    private final ObservationRegistry registry;

    // 프로젝트 패키지 경로에 맞게 수정
    @Pointcut("within(~~~~..controller..*) || " +
              "within(~~~~..service..*) || " +
              "within(~~~~..mapper..*)")
    public void tracingTarget() {}

    @Around("tracingTarget()")
    public Object traceObservation(ProceedingJoinPoint pjp) throws Throwable {
        String className = pjp.getSignature().getDeclaringType().getSimpleName();
        String methodName = pjp.getSignature().getName();
        String observationName = className + "." + methodName;

        return Observation.createNotStarted(observationName, registry)
            .observeChecked(() -> pjp.proceed());
    }
}
```

### 2.3 애플리케이션 설정 (`application.yml`)
로그 패턴에 `traceId`를 포함하고, Tempo 수신 위주 주소를 설정합니다.

```yaml
logging:
  pattern:
    # 로그에 traceId와 spanId가 자동으로 포함되도록 설정
    level: "%5p [${spring.application.name},%X{traceId:-},%X{spanId:-}]"
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} %magenta([%thread]) %highlight(%-5level) %cyan(%logger{36}) - %msg%n"
    file:    "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

management:
  endpoints:
    web:
      exposure:
        include: prometheus, health, info
  tracing:
    sampling:
      probability: 1.0 # 100% 수집 (테스트용, 운영 시 0.1 권장)
  otlp:
    tracing:
      # Tempo HTTP 수신기 주소
      endpoint: http://서버_IP:4318/v1/traces
  metrics:
    tags:
      application: ${spring.application.name}
```

### 2.4 Loki 전송 설정 (`logback-spring.xml`)
Loki로 로그를 보낼 때 `traceId`가 포함된 메시지 형식을 유지합니다.

```xml
<!-- LOKI Appender 정의 -->
<appender name="LOKI" class="com.github.loki4j.logback.Loki4jAppender">
    <http>
        <url>http://서버_IP:3100/loki/api/v1/push</url>
    </http>
    <format>
        <label>
            <pattern>app=${APP_NAME},host=${HOSTNAME},level=%level</pattern>
        </label>
        <message>
            <pattern>%-5level %d{yyyy-MM-dd HH:mm:ss.SSS} [%X{traceId:-}] %logger{36} - %msg%n</pattern>
        </message>
    </format>
</appender>
```

---

## 3. 그라파나(Grafana) 연동 및 확인

### 3.1 Tempo 데이터 소스 추가
1. **Connections -> Data Sources** 메뉴로 이동합니다.
2. **Add data source** 버튼을 누르고 **Tempo**를 검색하여 선택합니다.
3. **URL**: `http://localhost:3200`을 입력합니다.
4. 하단의 **Save & Test**를 클릭하여 연결을 확인합니다.

### 3.2 Loki와 Tempo 연결 (Derived Fields 설정)
로그(Loki)에서 트레이스(Tempo)로 즉시 전환할 수 있는 링크를 구성합니다.

1. **Loki 데이터 소스 설정**으로 들어갑니다.
2. 하단으로 스크롤하여 **Derived fields** 섹션에서 **+ Add**를 클릭합니다.
3. 상세 값을 다음과 같이 입력합니다:
   - **Name**: `traceId`
   - **Regex**: `\[(\w+)\]`
   - **Query**: `${__value.raw}`
   - **Internal link**: 활성화(Enabled)
   - **Internal link target**: 등록한 **Tempo** 데이터 소스 선택
4. **Save & Test**를 눌러 저장합니다.

---

## 4. 최종 동작 확인 (Drilldown 활용)

Grafana 대시보드나 탐색기에서 제공하는 **Drilldown** 기능을 이용하면 더 편리하게 추적할 수 있습니다.

1. **로그 접근**: 대시보드의 패널이나 Explore 메뉴에서 **drilldown > logs** 섹션으로 이동합니다.
2. **로그 확인**: **show logs**를 클릭하여 출력되는 로그 중 `traceId`가 포함된 로그를 선택합니다.
3. **Tempo 연결**: 로그 상세 보기 화면의 **links** 항목에 생성된 **Tempo** 버튼을 클릭합니다.
4. **타임라인 분석**: 우측에 나타나는 Tempo 타임라인을 통해 서비스 간 호출 관계와 병목 지점을 분석합니다.
