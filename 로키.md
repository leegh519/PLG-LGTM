# Grafana Loki 3.6.3 구축 및 연동 가이드 (LGTM 스택)

이 문서는 Rocky Linux 환경에서 Loki 3.6.3을 설치하고, 데이터를 저장하고 관리하며, Spring Boot 애플리케이션과 연동하는 전체 과정을 정리한 가이드입니다.

---

## 1. 서버 환경 준비 (Rocky Linux)
로키 실행을 위한 전용 계정과 데이터를 저장할 디렉토리를 생성합니다.

```bash
# 1. 로키 전용 계정 생성
sudo useradd --no-create-home --shell /bin/false loki

# 2. 데이터 및 설정 디렉토리 생성
sudo mkdir -p /etc/loki
sudo mkdir -p /var/lib/loki/chunks
sudo mkdir -p /var/lib/loki/rules
sudo mkdir -p /var/lib/loki/retention

# 3. 권한 부여
sudo chown -R loki:loki /etc/loki /var/lib/loki
```

## 2. Loki 3.6.3 설치
```bash
cd /tmp
# 바이너리 다운로드 및 압축 해제
curl -LO https://github.com/grafana/loki/releases/download/v3.6.3/loki-linux-amd64.zip
unzip loki-linux-amd64.zip

# 실행 파일 이동
sudo mv loki-linux-amd64 /usr/local/bin/loki
sudo chmod +x /usr/local/bin/loki
```

## 3. 최종 설정 (/etc/loki/loki.yaml)
보관 주기(30일)와 컴팩터 설정이 포함된 최종 확정 버전입니다.

```yaml
auth_enabled: false

server:
  http_listen_port: 3101
  grpc_listen_port: 9095

common:
  instance_addr: 127.0.0.1
  path_prefix: /var/lib/loki
  storage:
    filesystem:
      chunks_directory: /var/lib/loki/chunks
      rules_directory: /var/lib/loki/rules
  replication_factor: 1
  ring:
    kvstore:
      store: inmemory

query_range:
  results_cache:
    cache:
      embedded_cache:
        enabled: true
        max_size_mb: 100

schema_config:
  configs:
    - from: 2024-01-01
      store: tsdb
      object_store: filesystem
      schema: v13
      index:
        prefix: index_
        period: 24h

limits_config:
  max_query_lookback: 720h # 30일 동안 조회 가능
  retention_period: 720h   # 30일 뒤 물리적 삭제
  retention_enabled: true

compactor:
  working_directory: /var/lib/loki/retention
  compaction_interval: 10m
  retention_enabled: true
  retention_delete_delay: 2h
  retention_delete_worker_count: 150
  delete_request_cancel_period: 24h
  delete_request_store: filesystem
```

### 3.1 주요 설정값 상세 설명

| 설정 항목 | 의미 및 용도 |
| :--- | :--- |
| **`auth_enabled`** | 멀티 테넌시(사용자별 분리) 사용 여부입니다. 단일 서버 구성이므로 `false`로 설정합니다. |
| **`server`** | 로키가 요청을 기다리는 포트 설정입니다. HTTP 속도는 기본 `3100`을 사용합니다. |
| **`common.path_prefix`** | 로키의 인덱스 및 청크 데이터가 저장되는 기본 경로입니다. |
| **`schema_config`** | 데이터 저장 방식과 인덱스 주기를 설정합니다. `tsdb`와 `v13`은 최신 권장 설정입니다. |
| **`limits_config`** | 데이터 조회 및 보관 제한을 설정합니다. `retention_period: 720h`는 30일간 데이터를 보관한다는 의미입니다. |
| **`compactor`** | 오래된 데이터를 실제로 삭제하거나 압축하는 역할을 합니다. `retention_enabled: true`여야 실제 삭제가 수행됩니다. |
| **`retention_delete_delay`** | 삭제 결정 후 실제 물리적 삭제까지의 대기 시간입니다. 실수로 인한 삭제 방지 역할을 합니다. |

## 4. 서비스 등록 및 실행

### 4.1 Systemd 서비스 파일 생성
```bash
sudo vi /etc/systemd/system/loki.service
```

**[서비스 파일 내용]**
```ini
[Unit]
Description=Loki service
After=network.target

[Service]
Type=simple
User=loki
ExecStart=/usr/local/bin/loki -config.file=/etc/loki/loki.yaml
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

### 4.2 서비스 시작 및 방화벽 설정
```bash
# 1. 서비스 시작
sudo systemctl daemon-reload
sudo systemctl enable --now loki
```

---

## 5. Nginx를 이용한 보안 설정 (Basic Auth) - 권장
로키 자체에는 기본 인증 기능이 없으므로, Nginx를 역방향 프록시로 사용하여 보안을 강화합니다.

### 5.1 htpasswd 도구 설치 및 계정 생성
로그를 전송하거나 조회할 때 사용할 아이디와 비밀번호를 생성합니다.

```bash
# 아파치 유틸리티 설치 (htpasswd 사용)
sudo dnf install httpd-tools -y

# 계정 생성 (아이디: loki_auth_id)
# 실행 후 사용할 비밀번호를 두 번 입력합니다.
sudo htpasswd -c /etc/nginx/.htpasswd loki_auth_id
```

### 5.2 Nginx 설정 변경
외부의 3100번 포트 요청을 받아 인증을 확인한 후, 내부의 3101번(로키) 포트로 전달하도록 설정합니다.

```bash
sudo vi /etc/nginx/conf.d/loki_proxy.conf
```

**[loki_proxy.conf 내용]**
```nginx
server {
    listen 3100; # 외부 접속 포트

    location / {
        auth_basic "Loki Access Restricted";
        auth_basic_user_file /etc/nginx/.htpasswd;

        proxy_pass http://127.0.0.1:3101; # 실제 로키 포트
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

Nginx를 시작(또는 재시작)하고 방화벽 포트를 개방합니다.
```bash
nginx -t
sudo systemctl restart nginx
```

---

## 6. 그라파나 연동
1.  **그라파나 웹 접속**: `http://서버IP:3000`
2.  좌측 메뉴: **Connections** > **Data Sources** 클릭
3.  **Add data source** 버튼 클릭 후 **Loki** 선택
4.  **Connection 설정**:
    *   URL: `http://localhost:3101` (포트 번호 유의)
5.  **Auth 설정 (Basic Auth)**:
    *   **Basic Auth** 토글 활성화
    *   User: `username`
    *   Password: `password`
6.  하단 **Save & test** 버튼을 눌러 성공 메시지 확인

---

## 7. 스프링 부트 앱 연결
애플리케이션 로그를 Loki로 전송하기 위한 상세 설정(Maven/Gradle, Logback)은 아래 별도 가이드를 확인하세요.

👉 [**로키-스프링부트 연동 상세 가이드 바로가기**](./로키_스프링부트_연동.md)

---

## 8. 운용 및 검증

### 8.1 설정 문법 검사
서비스 재시작 전 아래 명령어로 설정 파일 오류를 미리 방지할 수 있습니다.
```bash
loki -verify-config -config.file=/etc/loki/loki.yaml
```

### 8.2 로그 확인 (Grafana)
1.  Grafana에서  **drilldown > log** 메뉴를 통해 관련 로그를 확인할 수 있습니다.
2.  또는 **Explore** 메뉴에서 데이터 소스를 **Loki**로 선택하고 `{app="your-app-name"}` 쿼리를 입력하여 로그를 직접 조회할 수 있습니다.

---

> **참고**: 이 가이드는 싱글 노드 구성에 최적화되어 있습니다. 향후 트래픽 증가로 인해 성능 저하가 발생할 경우 로키의 Read와 Write 경로를 분리하는 마이크로서비스 모드로 확장이 필요할 수 있습니다.
