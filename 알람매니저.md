# Prometheus Alertmanager 0.30.1 ì„¤ì¹˜ ë° ì„¤ì • ê°€ì´ë“œ

ì´ ë¬¸ì„œëŠ” Rocky Linux í™˜ê²½ì—ì„œ Alertmanager 0.30.1ì„ ì„¤ì¹˜í•˜ê³ , ì´ë©”ì¼ì„ í†µí•´ ì—¬ëŸ¬ ìˆ˜ì‹ ì¸ì—ê²Œ ì•ŒëŒì„ ì „ì†¡í•˜ë©°, í”„ë¡œë©”í…Œìš°ìŠ¤ì™€ ì—°ë™í•˜ëŠ” ì „ì²´ ê³¼ì •ì„ ì •ë¦¬í•œ ê°€ì´ë“œì…ë‹ˆë‹¤.

---

## 1. Alertmanager ì„¤ì¹˜ ë° ì„œë¹„ìŠ¤ ë“±ë¡

### 1.1 ì‚¬ìš©ì ìƒì„± ë° ë°”ì´ë„ˆë¦¬ ë°°ì¹˜
ë³´ì•ˆì„ ìœ„í•´ ì „ìš© ê³„ì •ì„ ìƒì„±í•˜ê³  ìµœì‹  ì‹¤í–‰ íŒŒì¼ì„ ë°°ì¹˜í•©ë‹ˆë‹¤.

```bash
# ì „ìš© ê³„ì • ìƒì„±
sudo useradd --no-create-home --shell /bin/false alertmanager

# 0.30.1 ë‹¤ìš´ë¡œë“œ ë° ì••ì¶• í•´ì œ
cd /tmp
curl -LO https://github.com/prometheus/alertmanager/releases/download/v0.30.1/alertmanager-0.30.1.linux-amd64.tar.gz
tar xvf alertmanager-0.30.1.linux-amd64.tar.gz

# ì‹¤í–‰ íŒŒì¼ ì´ë™ ë° ê¶Œí•œ ì„¤ì •
sudo mv alertmanager-0.30.1.linux-amd64/alertmanager /usr/local/bin/
sudo chown alertmanager:alertmanager /usr/local/bin/alertmanager
sudo chmod +x /usr/local/bin/alertmanager

# ë°ì´í„° ë° ì„¤ì • ë””ë ‰í† ë¦¬ ìƒì„±
sudo mkdir -p /etc/alertmanager /var/lib/alertmanager
sudo chown -R alertmanager:alertmanager /etc/alertmanager /var/lib/alertmanager
```

### 1.2 Systemd ì„œë¹„ìŠ¤ ë“±ë¡
ì•ŒëŒë§¤ë‹ˆì €ê°€ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤. 0.30.1 ë²„ì „ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ê¶Œí•œ ë¬¸ì œë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ `--storage.path`ë¥¼ ëª…ì‹œí•©ë‹ˆë‹¤.

```bash
sudo vi /etc/systemd/system/alertmanager.service
```

**[ì„œë¹„ìŠ¤ íŒŒì¼ ë‚´ìš©]**
```ini
[Unit]
Description=Alertmanager
Wants=network-online.target
After=network-online.target

[Service]
User=alertmanager
Group=alertmanager
Type=simple
ExecStart=/usr/local/bin/alertmanager \
    --config.file=/etc/alertmanager/alertmanager.yml \
    --storage.path=/var/lib/alertmanager/

[Install]
WantedBy=multi-user.target
```

---

## 2. ì´ë©”ì¼ ì•Œë¦¼ ì„¤ì • (alertmanager.yml)
ì§€ì •í•œ ìˆ˜ì‹ ì¸ì—ê²Œ ê°œë³„ì ìœ¼ë¡œ ë©”ì¼ì´ ë°œì†¡ë˜ë„ë¡ êµ¬ì„±í•©ë‹ˆë‹¤.

```bash
sudo vi /etc/alertmanager/alertmanager.yml
```

**[ì„¤ì • íŒŒì¼ ë‚´ìš©]**
```yaml
global:
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'ë°œì‹ ì¸@gmail.com'
  smtp_auth_username: 'ë°œì‹ ì¸@gmail.com'
  smtp_auth_password: 'êµ¬ê¸€_ì•±_ë¹„ë°€ë²ˆí˜¸' # 16ìë¦¬ ì•± ë¹„ë°€ë²ˆí˜¸

route:
  group_by: ['alertname']
  group_wait: 30s        # ì²« ì•ŒëŒ ë°œìƒ ì‹œ 30ì´ˆ ëŒ€ê¸° í›„ ë°œì†¡
  group_interval: 5m     # ì¶”ê°€ ì•ŒëŒ ë°œìƒ ì‹œ 5ë¶„ ê°„ê²©ìœ¼ë¡œ ëª¨ì•„ì„œ ë°œì†¡
  repeat_interval: 1h    # ë¬¸ì œ ì§€ì† ì‹œ 1ì‹œê°„ë§ˆë‹¤ ë°˜ë³µ ë°œì†¡
  receiver: 'email-group'

receivers:
  - name: 'email-group'
    email_configs:
      - to: 'email@email.co.kr'
        # send_resolved: true # í•´ê²° ì‹œ ë©”ì¼ ë°œì†¡
```

---

## 3. ì•ŒëŒ ê·œì¹™(Alert Rules) ì˜µì…˜ ìƒì„¸ ì„¤ëª…
`alert_rules.yml`ì— ì‘ì„±ë˜ëŠ” ê° ì˜µì…˜ì€ ë‹¤ìŒê³¼ ê°™ì€ ì˜ë¯¸ë¥¼ ê°€ì§‘ë‹ˆë‹¤.

| ì˜µì…˜ëª… | ì„¤ëª… | ì˜ˆì‹œ |
| :--- | :--- | :--- |
| **alert** | ì•ŒëŒì˜ ê³ ìœ í•œ ì´ë¦„ì…ë‹ˆë‹¤. ë©”ì¼ ì œëª© ë“±ì— ì‚¬ìš©ë©ë‹ˆë‹¤. | `HighCpuUsage` |
| **expr** | ì•ŒëŒì„ ë°œìƒì‹œí‚¬ ì¡°ê±´ì‹ì„ PromQLë¡œ ì‘ì„±í•©ë‹ˆë‹¤. | `cpu_usage > 80` |
| **for** | ì¡°ê±´ì´ ì°¸(True)ì¸ ìƒíƒœê°€ ì–¼ë§ˆë‚˜ ì§€ì†ë˜ì–´ì•¼ ì•ŒëŒì„ ë³´ë‚¼ì§€ ê²°ì •í•©ë‹ˆë‹¤. | `5m` (5ë¶„ê°„ ì§€ì† ì‹œ ë°œìƒ) |
| **labels** | ì•ŒëŒì˜ **ìš°ì„ ìˆœìœ„(Severity)**ë‚˜ ë‹´ë‹¹ íŒ€ ë“±ì„ êµ¬ë¶„í•˜ëŠ” ë¼ë²¨ì„ ë¶™ì…ë‹ˆë‹¤. | `severity: critical` |
| **annotations** | ì•ŒëŒ ë©”ì¼ì— ë‹´ê¸¸ ìƒì„¸ ë‚´ìš©ì„ ì‘ì„±í•©ë‹ˆë‹¤. ë³€ìˆ˜ ì‚¬ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. | `summary`, `description` |

### ğŸ’¡ ì£¼ìš” ë³€ìˆ˜ ì„¤ëª…
*   **`{{ $labels.instance }}`**: ì•ŒëŒì´ ë°œìƒí•œ ì„œë²„ì˜ **ì£¼ì†Œì™€ í¬íŠ¸(ì˜ˆ: localhost:9100)**ë¥¼ ìë™ìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.
*   **`{{ $value }}`**: ì•ŒëŒì´ ë°œìƒí•œ ì‹œì ì˜ ì‹¤ì œ ìˆ˜ì¹˜(ì˜ˆ: CPU 85.3%)ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.

---

## 4. í”„ë¡œë©”í…Œìš°ìŠ¤ ì—°ë™ ì„¤ì • (prometheus.yml)
í”„ë¡œë©”í…Œìš°ìŠ¤ì—ì„œ íƒì§€í•œ ì´ë²¤íŠ¸ë¥¼ ì•ŒëŒë§¤ë‹ˆì €ë¡œ ì „ë‹¬í•˜ê³ , ì•ŒëŒ ê·œì¹™ íŒŒì¼ì„ ë¡œë“œí•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.

```bash
sudo vi /etc/prometheus/prometheus.yml
```

**[prometheus.yml ì¶”ê°€ ë‚´ìš©]**
```yaml
# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - localhost:9093

# ì•ŒëŒ ê·œì¹™ íŒŒì¼ ê²½ë¡œ ì§€ì •
rule_files:
  - "alert_rules.yml"
```

---

## 5. ì•ŒëŒ ê·œì¹™ ì„¤ì • ì˜ˆì‹œ (alert_rules.yml)
ì„œë²„ ìƒíƒœë¥¼ ê°ì‹œí•˜ê³  íŠ¹ì • ì„ê³„ì¹˜ë¥¼ ë„˜ì„ ë•Œ ì•ŒëŒì„ ë°œìƒì‹œí‚¤ê¸° ìœ„í•œ ì„¤ì • íŒŒì¼ì…ë‹ˆë‹¤.

```bash
sudo vi /etc/prometheus/alert_rules.yml
```

**[alert_rules.yml ë‚´ìš©]**
```yaml
groups:
  - name: server_monitoring_alerts
    rules:
      # 1. ì„œë²„ ë‹¤ìš´ ì•ŒëŒ (Instance Down)
      - alert: InstanceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "ì„œë²„ ë‹¤ìš´ íƒì§€ ({{ $labels.instance }})"
          description: "ì„œë²„ì™€ì˜ ì—°ê²°ì´ 1ë¶„ ì´ìƒ ëŠê²¼ìŠµë‹ˆë‹¤. ì¦‰ê°ì ì¸ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."

      # 2. CPU ê³¼ë¶€í•˜ ì•ŒëŒ (CPU Usage > 80%)
      - alert: HighCpuUsage
        expr: (100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CPU ì‚¬ìš©ë¥  ë†’ìŒ ({{ $labels.instance }})"
          description: "ìµœê·¼ 5ë¶„ê°„ CPU ì‚¬ìš©ë¥ ì´ 80%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. (í˜„ì¬ê°’: {{ $value | printf \"%.2f\" }}%)"

      # 3. ë¨ ì‚¬ìš©ëŸ‰ ì•ŒëŒ (RAM Usage > 90%)
      - alert: HighRamUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "ë©”ëª¨ë¦¬ ë¶€ì¡± ê²½ê³  ({{ $labels.instance }})"
          description: "ì‹¤ì œ ì‚¬ìš© ê°€ëŠ¥í•œ ë©”ëª¨ë¦¬ê°€ 10% ë¯¸ë§Œì…ë‹ˆë‹¤. OOM Killerì— ì˜í•œ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ ì‚¬ìš©ë¥ : {{ $value | printf \"%.2f\" }}%)"

      # 4. ë””ìŠ¤í¬ ìš©ëŸ‰ ë¶€ì¡± ì•ŒëŒ (Disk Free < 10%)
      - alert: LowDiskSpace
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 10
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "ë””ìŠ¤í¬ ì”ì—¬ëŸ‰ ë¶€ì¡± ({{ $labels.instance }})"
          description: "ë£¨íŠ¸(/) íŒŒí‹°ì…˜ì˜ ê³µê°„ì´ 10% ë¯¸ë§Œìœ¼ë¡œ ë‚¨ì•˜ìŠµë‹ˆë‹¤. ë¡œê·¸ ì •ë¦¬ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ ì‚¬ìš©ëŸ‰: {{ $value | printf \"%.2f\" }}%)"

      # 5. ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ íƒì§€ (Network Errors)
      # - alert: NetworkInterfaceErrors
      #   expr: increase(node_network_receive_errs_total[5m]) > 10 or increase(node_network_transmit_errs_total[5m]) > 10
      #   for: 2m
      #   labels:
      #     severity: warning
      #   annotations:
      #     summary: "ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì—ëŸ¬ ë°œìƒ ({{ $labels.instance }})"
      #     description: "ìµœê·¼ 5ë¶„ ë™ì•ˆ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚· ì—ëŸ¬ê°€ 10ê±´ ì´ìƒ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í•˜ë“œì›¨ì–´ ë˜ëŠ” ì¸í”„ë¼ ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤."

      # 6. ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ í­ì¦ (High Network Traffic)
      # 50MB/s ì´ìƒì˜ íŠ¸ë˜í”½ì´ 5ë¶„ê°„ ì§€ì†ë  ë•Œ (ì„œë²„ í™˜ê²½ì— ë§ì¶° ì¡°ì ˆ ê°€ëŠ¥)
      # - alert: HighNetworkTraffic
      #   expr: (sum by (instance) (irate(node_network_receive_bytes_total[5m])) + sum by (instance) (irate(node_network_transmit_bytes_total[5m]))) > 50 * 1024 * 1024
      #   for: 5m
      #   labels:
      #     severity: warning
      #   annotations:
      #     summary: "ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ê¸‰ì¦ ({{ $labels.instance }})"
      #     description: "ì´ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì´ 50MB/së¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë¹„ì •ìƒì ì¸ ì ‘ê·¼ì´ë‚˜ ë°ì´í„° ì „ì†¡ì¸ì§€ í™•ì¸í•˜ì„¸ìš”."


######### íŠ¹ì • ì„œë²„ì—ë§Œ ì•ŒëŒ ì¡°ê±´ ì ìš© ë°©ë²• #########
# groups:
#   - name: monitoring_server_rules
#     rules:
#       # monitoring_serverì—ë§Œ ì ìš©ë˜ëŠ” ë©”ëª¨ë¦¬ ì•ŒëŒ
#       - alert: monitoring_server_HighMem
#         expr: (1 - (node_memory_MemAvailable_bytes{server_name="monitoring_server"} / node_memory_MemTotal_bytes{server_name="monitoring_server"})) * 100 > 95
#         for: 1m
#         labels:
#           severity: critical
#           receiver_group: 'lgh'  # ì•ŒëŒë§¤ë‹ˆì €ì—ì„œ ë¶„ë¥˜í•  ë¼ë²¨
#         annotations:
#           summary: "ëª¨ë‹ˆí„°ë§ ì„œë²„ ë©”ëª¨ë¦¬ ì„ê³„ì¹˜ ì´ˆê³¼"
```

---

## 6. íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ë° í•´ê²° (SELinux)
ì„œë¹„ìŠ¤ ì‹œì‘ ì‹œ `status=203/EXEC` ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤ë©´ SELinuxê°€ ì‹¤í–‰ íŒŒì¼ì˜ ë³´ì•ˆ ê¶Œí•œì„ ì°¨ë‹¨í•œ ê²ƒì…ë‹ˆë‹¤. ì•„ë˜ ëª…ë ¹ì–´ë¡œ ë³´ì•ˆ ê¼¬ë¦¬í‘œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.

```bash
# íŒŒì¼ì— ì‹œìŠ¤í…œ ì‹¤í–‰ ê¶Œí•œ ê¼¬ë¦¬í‘œ ë¶€ì—¬
sudo chcon -t bin_t /usr/local/bin/alertmanager

# ì„œë¹„ìŠ¤ ì¬ì‹œì‘
sudo systemctl daemon-reload
sudo systemctl restart alertmanager
```

---

## 7. ì„¤ì • í™•ì¸ ë° í…ŒìŠ¤íŠ¸

1.  **ì„¤ì • ë°˜ì˜**: 
    ```bash
    # í”„ë¡œë©”í…Œìš°ìŠ¤ ê·œì¹™ íŒŒì¼ ì´ìƒ ìœ ë¬´ í™•ì¸
    /usr/local/bin/amtool check-config /etc/alertmanager/alertmanager.yml
    /usr/local/bin/promtool check rules /etc/prometheus/prometheus.yml

    # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
    sudo systemctl restart alertmanager
    sudo systemctl restart prometheus
    ```
2.  **í”„ë¡œë©”í…Œìš°ìŠ¤ ì—°ë™ í™•ì¸**: `http://ì„œë²„IP:9090/alerts` í˜ì´ì§€ì—ì„œ ì‘ì„±í•œ ê·œì¹™ë“¤ì´ `Inactive` ìƒíƒœë¡œ ë³´ì´ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
3.  **í…ŒìŠ¤íŠ¸**: `sudo systemctl stop node_exporter`ë¥¼ ì…ë ¥í•˜ì—¬ ê°•ì œë¡œ ì„œë²„ ë‹¤ìš´ ìƒí™©ì„ ë§Œë“  ë’¤, ì ì‹œ í›„ ì´ë©”ì¼ì´ ë„ì°©í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
