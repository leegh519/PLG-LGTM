# Prometheus Alertmanager 0.30.1 설치 및 설정 가이드

이 문서는 Rocky Linux 환경에서 Alertmanager 0.30.1을 설치하고, 이메일을 통해 여러 수신인에게 알람을 전송하며, 프로메테우스와 연동하는 전체 과정을 정리한 가이드입니다.

---

## 1. Alertmanager 설치 및 서비스 등록

### 1.1 사용자 생성 및 바이너리 배치
보안을 위해 전용 계정을 생성하고 최신 실행 파일을 배치합니다.

```bash
# 전용 계정 생성
sudo useradd --no-create-home --shell /bin/false alertmanager

# 0.30.1 다운로드 및 압축 해제
cd /tmp
curl -LO https://github.com/prometheus/alertmanager/releases/download/v0.30.1/alertmanager-0.30.1.linux-amd64.tar.gz
tar xvf alertmanager-0.30.1.linux-amd64.tar.gz

# 실행 파일 이동 및 권한 설정
sudo mv alertmanager-0.30.1.linux-amd64/alertmanager /usr/local/bin/
sudo chown alertmanager:alertmanager /usr/local/bin/alertmanager
sudo chmod +x /usr/local/bin/alertmanager

# 데이터 및 설정 디렉토리 생성
sudo mkdir -p /etc/alertmanager /var/lib/alertmanager
sudo chown -R alertmanager:alertmanager /etc/alertmanager /var/lib/alertmanager
```

### 1.2 Systemd 서비스 등록
알람매니저가 자동으로 실행되도록 설정합니다. 0.30.1 버전에서 발생할 수 있는 권한 문제를 방지하기 위해 `--storage.path`를 명시합니다.

```bash
sudo vi /etc/systemd/system/alertmanager.service
```

**[서비스 파일 내용]**
```ini
[Unit]
Description=Alertmanager
Wants=network-online.target
After=network-online.target

[Service]
User=alertmanager
Group=alertmanager
Type=simple
ExecStart=/usr/local/bin/alertmanager \
    --config.file=/etc/alertmanager/alertmanager.yml \
    --storage.path=/var/lib/alertmanager/

[Install]
WantedBy=multi-user.target
```

---

## 2. 이메일 알림 설정 (alertmanager.yml)
지정한 수신인에게 개별적으로 메일이 발송되도록 구성합니다.

```bash
sudo vi /etc/alertmanager/alertmanager.yml
```

**[설정 파일 내용]**
```yaml
global:
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: '발신인@gmail.com'
  smtp_auth_username: '발신인@gmail.com'
  smtp_auth_password: '구글_앱_비밀번호' # 16자리 앱 비밀번호

route:
  group_by: ['alertname']
  group_wait: 30s        # 첫 알람 발생 시 30초 대기 후 발송
  group_interval: 5m     # 추가 알람 발생 시 5분 간격으로 모아서 발송
  repeat_interval: 1h    # 문제 지속 시 1시간마다 반복 발송
  receiver: 'email-group'

receivers:
  - name: 'email-group'
    email_configs:
      - to: 'email@email.co.kr'
        # send_resolved: true # 해결 시 메일 발송
```

---

## 3. 알람 규칙(Alert Rules) 옵션 상세 설명
`alert_rules.yml`에 작성되는 각 옵션은 다음과 같은 의미를 가집니다.

| 옵션명 | 설명 | 예시 |
| :--- | :--- | :--- |
| **alert** | 알람의 고유한 이름입니다. 메일 제목 등에 사용됩니다. | `HighCpuUsage` |
| **expr** | 알람을 발생시킬 조건식을 PromQL로 작성합니다. | `cpu_usage > 80` |
| **for** | 조건이 참(True)인 상태가 얼마나 지속되어야 알람을 보낼지 결정합니다. | `5m` (5분간 지속 시 발생) |
| **labels** | 알람의 **우선순위(Severity)**나 담당 팀 등을 구분하는 라벨을 붙입니다. | `severity: critical` |
| **annotations** | 알람 메일에 담길 상세 내용을 작성합니다. 변수 사용이 가능합니다. | `summary`, `description` |

### 💡 주요 변수 설명
*   **`{{ $labels.instance }}`**: 알람이 발생한 서버의 **주소와 포트(예: localhost:9100)**를 자동으로 출력합니다.
*   **`{{ $value }}`**: 알람이 발생한 시점의 실제 수치(예: CPU 85.3%)를 출력합니다.

---

## 4. 트러블슈팅 및 해결 (SELinux)
서비스 시작 시 `status=203/EXEC` 에러가 발생한다면 SELinux가 실행 파일의 보안 권한을 차단한 것입니다. 아래 명령어로 보안 꼬리표를 수정하세요.

```bash
# 파일에 시스템 실행 권한 꼬리표 부여
sudo chcon -t bin_t /usr/local/bin/alertmanager

# 서비스 재시작
sudo systemctl daemon-reload
sudo systemctl restart alertmanager
```

---

## 5. 설정 확인 및 테스트

1.  **설정 반영**: 
    ```bash
    # 프로메테우스 규칙 파일 이상 유무 확인
    /usr/local/bin/amtool check-config /etc/alertmanager/alertmanager.yml
    /usr/local/bin/promtool check rules /etc/prometheus/prometheus.yml

    # 서비스 재시작
    sudo systemctl restart alertmanager
    sudo systemctl restart prometheus
    ```
2.  **프로메테우스 연동 확인**: `http://서버IP:9090/alerts` 페이지에서 작성한 규칙들이 `Inactive` 상태로 보이는지 확인합니다.
3.  **테스트**: `sudo systemctl stop node_exporter`를 입력하여 강제로 서버 다운 상황을 만든 뒤, 잠시 후 이메일이 도착하는지 확인합니다.
