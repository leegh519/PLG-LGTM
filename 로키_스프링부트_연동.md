# Spring Boot + Loki 연동 가이드 (Maven 기준)

이 문서는 Maven 기반 Spring Boot 애플리케이션의 로그와 메트릭을 Loki 및 Prometheus로 전송하기 위한 설정 방법을 가이드합니다. 특히 **운영 환경(prod)에서만 로그가 전송되도록** 프로파일 설정을 포함합니다.

---

## 1. 의존성 추가 (pom.xml)

`pom.xml`의 `<dependencies>` 섹션에 아래 내용을 추가합니다.

```xml
<!-- loki logback appender 및 모니터링 관련 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>
<dependency>
    <groupId>com.github.loki4j</groupId>
    <artifactId>loki-logback-appender</artifactId>
    <version>1.6.0</version>
</dependency>
```

---

## 2. 애플리케이션 설정 (application.yml)

애플리케이션 이름과 메트릭 노출 설정을 추가합니다.

```yaml
spring:
  application:
    name: cafecare

---
# 운영 환경 프로파일 (prod)
spring:
  config:
    activate:
      on-profile: prod

management:
  endpoints:
    web:
      exposure:
        include: prometheus, health, info
  metrics:
    tags:
      application: ${spring.application.name}
```

---

## 3. Actuator 보안 설정 

운영 환경에서 Actuator 엔드포인트를 노출할 경우, 특정 IP에서만 접근 가능하도록 제한하는 것이 보안상 안전합니다. 아래는 Spring Security를 사용한 IP 제한 설정 예시입니다.

```java
// SecurityConfig.java 내 FilterChain 설정 예시
.authorizeHttpRequests(authorize -> authorize
    // ... 기존 설정 ...
    
    // actuator 접근 IP 제한
    .requestMatchers(AntPathRequestMatcher.antMatcher("/actuator/**"))
    .access((authentication, object) -> {
        try {
            // 허용할 모니터링 서버 IP
            String allowedIp = "서버_IP";
            return new AuthorizationDecision(
                new IpAddressMatcher(allowedIp).matches(PropertyUtil.getClientIpAddr(object.getRequest()))
            );
        } catch (UnknownHostException e) {
            return new AuthorizationDecision(false);
        }
    })
    
    .anyRequest().authenticated()
)
```

> **참고**: `PropertyUtil.getClientIpAddr`는 프로젝트 내 구현된 IP 추출 유틸리티 클래스입니다. 프록시나 로드밸런서를 사용하는 경우 `X-Forwarded-For` 헤더를 고려하여 IP를 추출하도록 구현되어야 합니다.

---

## 4. 로그백 설정 (logback-spring.xml)

`src/main/resources/logback-spring.xml` 파일을 아래와 같이 구성합니다. `springProperty`를 통해 YAML에 정의된 앱 이름을 가져오고, 환경별로 로그 전송 여부를 결정합니다.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    ...
    
    <!-- YAML의 spring.application.name을 APP_NAME 변수로 가져옴 -->
    <springProperty scope="context" name="APP_NAME" source="spring.application.name"/>

    ...

    <!-- LOKI Appender 정의 -->
    <appender name="LOKI" class="com.github.loki4j.logback.Loki4jAppender">
        <http>
            <url>http://your_loki_ip:your_loki_port/loki/api/v1/push</url>
            <!-- 로키 인증 -->
            <auth>
                <username>username</username>
                <password>password</password>
            </auth>
        </http>
        <format>
            <label>
                <pattern>app=${APP_NAME},host=${HOSTNAME},level=%level</pattern>
            </label>
            <message>
                <pattern>%-5level %d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %logger{36} - %msg%n</pattern>
            </message>
            <sortByTime>true</sortByTime>
        </format>
    </appender>


    <!-- 개발/기타 환경 설정: 로컬 부하 방지를 위해 콘솔 또는 파일 출력 -->
    <springProfile name="local">
        <root level="WARN">
            <appender-ref ref="CONSOLE"/>
        </root>
        <logger name="p6spy" level="INFO"/>
    </springProfile>

    <springProfile name="dev">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
        </root>
        <logger name="p6spy" level="INFO"/>
    </springProfile>

    <!-- 운영 환경(prod) 설정: 로그를 콘솔과 로키 모두로 전송 -->
    <springProfile name="prod">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="LOKI"/>
        </root>
        <logger name="p6spy" level="WARN"/>
    </springProfile>

    <!-- 특정 로거 레벨 및 additivity 설정 -->
    <logger name="org.springframework.web" level="INFO"/>
    <logger name="org.hibernate" level="WARN"/>
</configuration>
```


---

## 5. 프로메테우스 서버 설정 업데이트 (prometheus.yml)
모니터링 서버의 프로메테우스가 스프링 부트 앱의 데이터를 수집하도록 설정을 추가합니다.

```bash
sudo vi /etc/prometheus/prometheus.yml
```

**[내용 추가]**
```yaml
  - job_name: 'spring_application'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['your.domain.com']
        labels:
          server_name: 'service_name' # 대시보드 변수와 매칭될 라벨
```

설정 검사 후 프로메테우스 서버를 재시작합니다.
```bash
/usr/local/bin/promtool check rules /etc/prometheus/prometheus.yml
sudo systemctl restart prometheus
```

---

## 6. 중요 운영 대원칙

### 🛑 프로파일 구분이 안 되는 경우
만약 시스템 제약으로 인해 `springProfile` 기능을 사용할 수 없다면, **배포 전 반드시 아래와 같이 수동으로 조치**해야 합니다.

1.  **로컬/개발 환경**: `logback-spring.xml`에서 `LOKI` 어펜더 참조 부분을 주석 처리합니다.
2.  **운영 환경 배포 시**: 주석을 해제하여 배포합니다.

### 💡 설정 팁
*   **`APP_NAME`**: `${spring.application.name}` 값을 자동으로 물고 오므로, 여러 앱에 복사해서 쓸 때 유용합니다.
*   **`management.endpoints`**: 프로메테우스가 데이터를 긁어갈 수 있도록 `/actuator/prometheus` 엔드포인트를 열어둔 상태입니다.
