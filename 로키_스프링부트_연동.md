# Spring Boot + Loki ì—°ë™ ê°€ì´ë“œ (Maven ê¸°ì¤€)

ì´ ë¬¸ì„œëŠ” Maven ê¸°ë°˜ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¡œê·¸ì™€ ë©”íŠ¸ë¦­ì„ Loki ë° Prometheusë¡œ ì „ì†¡í•˜ê¸° ìœ„í•œ ì„¤ì • ë°©ë²•ì„ ê°€ì´ë“œí•©ë‹ˆë‹¤. íŠ¹íˆ **ìš´ì˜ í™˜ê²½(prod)ì—ì„œë§Œ ë¡œê·¸ê°€ ì „ì†¡ë˜ë„ë¡** í”„ë¡œíŒŒì¼ ì„¤ì •ì„ í¬í•¨í•©ë‹ˆë‹¤.

---

## 1. ì˜ì¡´ì„± ì¶”ê°€ (pom.xml)

`pom.xml`ì˜ `<dependencies>` ì„¹ì…˜ì— ì•„ë˜ ë‚´ìš©ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

```xml
<!-- loki logback appender ë° ëª¨ë‹ˆí„°ë§ ê´€ë ¨ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>
<dependency>
    <groupId>com.github.loki4j</groupId>
    <artifactId>loki-logback-appender</artifactId>
    <version>1.6.0</version>
</dependency>
```

---

## 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì • (application.yml)

ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„ê³¼ ë©”íŠ¸ë¦­ ë…¸ì¶œ ì„¤ì •ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

```yaml
spring:
  application:
    name: cafecare

---
# ìš´ì˜ í™˜ê²½ í”„ë¡œíŒŒì¼ (prod)
spring:
  config:
    activate:
      on-profile: prod

management:
  endpoints:
    web:
      exposure:
        include: prometheus, health, info
  metrics:
    tags:
      application: ${spring.application.name}
```

---

## 3. ë¡œê·¸ë°± ì„¤ì • (logback-spring.xml)

`src/main/resources/logback-spring.xml` íŒŒì¼ì„ ì•„ë˜ì™€ ê°™ì´ êµ¬ì„±í•©ë‹ˆë‹¤. `springProperty`ë¥¼ í†µí•´ YAMLì— ì •ì˜ëœ ì•± ì´ë¦„ì„ ê°€ì ¸ì˜¤ê³ , í™˜ê²½ë³„ë¡œ ë¡œê·¸ ì „ì†¡ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    ...
    
    <!-- YAMLì˜ spring.application.nameì„ APP_NAME ë³€ìˆ˜ë¡œ ê°€ì ¸ì˜´ -->
    <springProperty scope="context" name="APP_NAME" source="spring.application.name"/>

    ...

    <!-- LOKI Appender ì •ì˜ -->
    <appender name="LOKI" class="com.github.loki4j.logback.Loki4jAppender">
        <http>
            <url>http://your_loki_ip:your_loki_port/loki/api/v1/push</url>
            <!-- ë¡œí‚¤ ì¸ì¦ -->
            <auth>
                <username>username</username>
                <password>password</password>
            </auth>
        </http>
        <format>
            <label>
                <pattern>app=${APP_NAME},host=${HOSTNAME},level=%level</pattern>
            </label>
            <message>
                <pattern>%-5level %d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %logger{36} - %msg%n</pattern>
            </message>
            <sortByTime>true</sortByTime>
        </format>
    </appender>


    <!-- ê°œë°œ/ê¸°íƒ€ í™˜ê²½ ì„¤ì •: ë¡œì»¬ ë¶€í•˜ ë°©ì§€ë¥¼ ìœ„í•´ ì½˜ì†” ë˜ëŠ” íŒŒì¼ ì¶œë ¥ -->
    <springProfile name="local">
        <root level="WARN">
            <appender-ref ref="CONSOLE"/>
        </root>
        <logger name="p6spy" level="INFO"/>
    </springProfile>

    <springProfile name="dev">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
        </root>
        <logger name="p6spy" level="INFO"/>
    </springProfile>

    <!-- ìš´ì˜ í™˜ê²½(prod) ì„¤ì •: ë¡œê·¸ë¥¼ ì½˜ì†”ê³¼ ë¡œí‚¤ ëª¨ë‘ë¡œ ì „ì†¡ -->
    <springProfile name="prod">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="LOKI"/>
        </root>
        <logger name="p6spy" level="WARN"/>
    </springProfile>

    <!-- íŠ¹ì • ë¡œê±° ë ˆë²¨ ë° additivity ì„¤ì • -->
    <logger name="org.springframework.web" level="INFO"/>
    <logger name="org.hibernate" level="WARN"/>
</configuration>
```


---

## 4. í”„ë¡œë©”í…Œìš°ìŠ¤ ì„œë²„ ì„¤ì • ì—…ë°ì´íŠ¸ (prometheus.yml)
ëª¨ë‹ˆí„°ë§ ì„œë²„ì˜ í”„ë¡œë©”í…Œìš°ìŠ¤ê°€ ìŠ¤í”„ë§ ë¶€íŠ¸ ì•±ì˜ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ë„ë¡ ì„¤ì •ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

```bash
sudo vi /etc/prometheus/prometheus.yml
```

**[ë‚´ìš© ì¶”ê°€]**
```yaml
  - job_name: 'spring_application'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['your.domain.com']
        labels:
          server_name: 'service_name' # ëŒ€ì‹œë³´ë“œ ë³€ìˆ˜ì™€ ë§¤ì¹­ë  ë¼ë²¨
```

ì„¤ì • ê²€ì‚¬ í›„ í”„ë¡œë©”í…Œìš°ìŠ¤ ì„œë²„ë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤.
```bash
/usr/local/bin/promtool check rules /etc/prometheus/prometheus.yml
sudo systemctl restart prometheus
```

---

## 5. ì¤‘ìš” ìš´ì˜ ëŒ€ì›ì¹™

### ğŸ›‘ í”„ë¡œíŒŒì¼ êµ¬ë¶„ì´ ì•ˆ ë˜ëŠ” ê²½ìš°
ë§Œì•½ ì‹œìŠ¤í…œ ì œì•½ìœ¼ë¡œ ì¸í•´ `springProfile` ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤ë©´, **ë°°í¬ ì „ ë°˜ë“œì‹œ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ë™ìœ¼ë¡œ ì¡°ì¹˜**í•´ì•¼ í•©ë‹ˆë‹¤.

1.  **ë¡œì»¬/ê°œë°œ í™˜ê²½**: `logback-spring.xml`ì—ì„œ `LOKI` ì–´íœë” ì°¸ì¡° ë¶€ë¶„ì„ ì£¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
2.  **ìš´ì˜ í™˜ê²½ ë°°í¬ ì‹œ**: ì£¼ì„ì„ í•´ì œí•˜ì—¬ ë°°í¬í•©ë‹ˆë‹¤.

### ğŸ’¡ ì„¤ì • íŒ
*   **`APP_NAME`**: `${spring.application.name}` ê°’ì„ ìë™ìœ¼ë¡œ ë¬¼ê³  ì˜¤ë¯€ë¡œ, ì—¬ëŸ¬ ì•±ì— ë³µì‚¬í•´ì„œ ì“¸ ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.
*   **`management.endpoints`**: í”„ë¡œë©”í…Œìš°ìŠ¤ê°€ ë°ì´í„°ë¥¼ ê¸ì–´ê°ˆ ìˆ˜ ìˆë„ë¡ `/actuator/prometheus` ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì—´ì–´ë‘” ìƒíƒœì…ë‹ˆë‹¤.
