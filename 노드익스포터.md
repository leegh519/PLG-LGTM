# Rocky Linux 노드 익스포터(Node Exporter) 1.10.2 설치 가이드

이 문서는 모니터링 대상이 되는 각 서버(Rocky Linux 환경)에 노드 익스포터 1.10.2 버전을 설치하여 하드웨어 지표를 수집하기 위한 절차를 정리한 것입니다.

---

## 1. 노드 익스포터(Node Exporter)란?
노드 익스포터는 리눅스 서버의 CPU, 메모리, 디스크, 네트워크 사용량 등 하드웨어의 상태 지표(Metrics)를 수집하여 프로메테우스가 읽어갈 수 있도록 **9100번 포트**로 제공하는 에이전트입니다.

## 2. 전용 사용자 생성
보안을 위해 서비스 실행만을 담당하는 전용 시스템 계정을 생성합니다. 서비스가 공격받더라도 시스템 전체 권한(root)이 탈취되는 것을 방지하기 위함입니다.

```bash
# 홈 디렉토리 없이, 로그인 불가능한 시스템 계정 생성
sudo useradd --no-create-home --shell /bin/false node_exporter
```

## 3. 설치 및 서비스 등록

### 3.1 바이너리 다운로드 및 배치
```bash
cd /tmp
# 1.10.2 버전 다운로드 및 압축 해제
curl -LO https://github.com/prometheus/node_exporter/releases/download/v1.10.2/node_exporter-1.10.2.linux-amd64.tar.gz
tar xvf node_exporter-1.10.2.linux-amd64.tar.gz

# 실행 파일 이동 및 소유권 변경
sudo mv node_exporter-1.10.2.linux-amd64/node_exporter /usr/local/bin/
sudo chown node_exporter:node_exporter /usr/local/bin/node_exporter
```

### 3.2 서비스 파일 생성
```bash
sudo vi /etc/systemd/system/node_exporter.service
```

**[파일 내용]**
```ini
[Unit]
Description=Node Exporter
Wants=network-online.target
After=network-online.target

[Service]
User=node_exporter
Group=node_exporter
Type=simple
ExecStart=/usr/local/bin/node_exporter

[Install]
WantedBy=multi-user.target
```

## 4. [트러블슈팅] SELinux 실행 거부 문제 해결
서비스를 시작했을 때 `status=203/EXEC` 에러가 발생하며 실행이 안 된다면, 이는 SELinux가 외부에서 가져온 파일의 실행을 차단했기 때문입니다.

### 💡 문제 상황
`/tmp` 폴더에서 다운로드한 파일은 보안상 '임시 파일' 꼬리표(Context)를 가지고 있습니다. SELinux는 시스템 서비스가 이 꼬리표를 가진 파일을 실행하는 것을 허용하지 않습니다.

### ✅ 해결 방법
파일에 "시스템 실행 파일"이라는 올바른 보안 꼬리표를 부여해야 합니다.

```bash
# 파일에 bin_t(실행 파일 타입) 꼬리표 부여
sudo chcon -t bin_t /usr/local/bin/node_exporter
```
이후 서비스를 다시 시작하면 SELinux를 끄지 않고도 정상적으로 작동합니다.

## 5. 서비스 시작 및 연동

### 5.1 서비스 활성화
```bash
sudo systemctl daemon-reload
sudo systemctl enable --now node_exporter

# 상태 확인 (Active: active (running) 확인)
sudo systemctl status node_exporter
```

### 5.2 프로메테우스(Prometheus) 설정
프로메테우스 설정 파일(`prometheus.yml`)에 아래 내용을 추가하여 데이터를 수집하도록 합니다.

```yaml
scrape_configs:
  - job_name: "node_exporter"
    static_configs:
      # 모니터링할 대상 서버의 IP 주소를 적어줍니다.
      - targets: ["대상_서버_IP:9100"]
        labels:
          server_name: '서버_이름_지정' # 서버별 알람 설정을 위한 label 설정
```
수정 후 설정 파일에 이상이 없는지 확인한 뒤 프로메테우스를 재시작합니다: 
```bash
# 설정 및 규칙 파일 이상 유무 확인
/usr/local/bin/promtool check rules /etc/prometheus/prometheus.yml

# 프로메테우스 재시작
sudo systemctl restart prometheus
```
